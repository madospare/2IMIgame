using System.Collections;
using UnityEngine;
using UnityEngine.Networking;
using UnityEngine.UI;

public class Login : MonoBehaviour
{

    public GameObject loginScreen;
    public Button submit;
    public Text errorText;
    public InputField uidField;
    public InputField pwdField;

    string username = "";
    string password = "";
    string errorMessage = "";

    bool isWorking = false;
    bool loginComplete = false;
    bool isLoggedIn = false;

    string rootURL = "http://192.168.0.40/"; //Path where php files are located

    void OnGUI()
    {

        if (!isLoggedIn)
        {
            loginScreen.SetActive(true);
        }

        if (isWorking)
        {
            GUI.enabled = false;
        }

        if (errorMessage != "")
        {
            GUI.color = Color.red;
            GUILayout.Label(errorMessage);
            //Debug.Log("NO");
        }

        errorText.text = errorMessage;

        if (loginComplete)
        {
            loginScreen.SetActive(false);
            //Debug.Log("YES");
        }

        username = uidField.text;
        password = pwdField.text;

        submit.onClick.AddListener(() =>
        {
            StartCoroutine(LoginEnumerator());
        });

    }

    IEnumerator LoginEnumerator()
    {

        isWorking = true;
        errorMessage = "";

        WWWForm form = new WWWForm();
        form.AddField("uid", username);
        form.AddField("pwd", password);

        using (UnityWebRequest www = UnityWebRequest.Post(rootURL + "login.php", form))
        {

            yield return www.SendWebRequest();

            if (www.result != UnityWebRequest.Result.Success)
            {
                errorMessage = www.error;
            }
            else
            {
                string responseText = www.downloadHandler.text;
                Debug.Log(www.downloadHandler.text);

                if (!responseText.Equals("Error:"))
                {
                    isLoggedIn = true;
                    loginComplete = true;

                    ResetValues();
                }
                else
                {
                    errorMessage = "Error: Username or password is wrong! please try again. " + responseText;
                }
            }
        }

        isWorking = false;

    }

    void ResetValues()
    {

        errorMessage = "";
        password = "";
        username = "";

    }

}